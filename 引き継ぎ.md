# トイレットペーパー価格比較サイト - AWS デプロイ手順書

## 想定仕様

### 基本動作
1. **初回アクセス時**
   - DBが空の場合、自動的にAmazonをスクレイピング（約30秒）
   - 商品情報をChatGPTで解析（ロール数、長さ、単価を計算）
   - データをSupabase DBに保存
   - 単価順にソートして表示

2. **2回目以降のアクセス**
   - **DBから即座にデータを返す**（1秒以内）
   - スクレイピングは実行しない
   - キャッシュされたデータを表示

3. **定期更新（Lambda/4時間ごと）**
   - 既存商品の価格のみを更新
   - 商品名、画像、ロール数などは変更しない
   - 価格が20%以上変動した場合は再解析

4. **手動更新（開発環境のみ）**
   - localhost環境でのみ「価格を再取得」ボタンを表示
   - force=trueパラメータで強制スクレイピング

### 期待されるパフォーマンス
- **初回スクレイピング**: 30秒程度
- **DB読み込み**: 1秒以内
- **単価計算**: リアルタイム

### 主要機能
1. **価格比較**
   - 1メートルあたりの単価で自動ランキング
   - 1ロールあたりの単価も表示
   - セール品の識別と割引率表示

2. **フィルタリング**
   - シングル/ダブルで絞り込み
   - セール品のみ表示
   - リアルタイムフィルタリング

3. **商品情報の自動解析**
   - ChatGPT-3.5でトイレットペーパーの仕様を解析
   - 「3倍長持ち」などの表記を正しく物理ロール数に変換
   - 長さ×ロール数から総長を計算

4. **価格安定性**
   - 前回価格から20%以上変動した場合は再解析
   - セール中は大幅変動を許容
   - 価格履歴をprice_historyテーブルに記録

## ⚠️ 現状の課題（要修正）

### 1. **パフォーマンス問題**
- **初回スクレイピングに5分以上かかる**（通常は30秒程度のはず）
- 48商品の取得に異常に時間がかかっている
- 同じリクエストが複数回重複して実行される場合がある

### 2. **データベース保存の不具合**
- スクレイピングしたデータがDBに正しく保存されない
- `Error upserting products: All object keys must match` エラーが発生
- リロードすると再度初回スクレイピングが実行される（DBキャッシュが効いていない）

### 3. **必要な対応**
- Supabaseに`price_history`テーブルの作成が必要
- 複数商品の一括upsert時のフィールド整合性の問題を解決
- フロントエンドの重複リクエスト問題の解決

### 4. **動作確認済みの機能**
- ✅ ChatGPTによる商品情報解析（ロール数、長さ、単価計算）
- ✅ 価格変動検証システム（20%以上の変動で再解析）
- ✅ localhost環境でのみ「価格を再取得」ボタン表示
- ✅ ローディング中のスケルトンローダー表示

## 概要
このサイトはAmazonのトイレットペーパーを自動的にスクレイピングし、1メートルあたりの単価でランキング表示するサービスです。

### アーキテクチャ
- **フロントエンド**: Next.js (Vercel)
- **バックエンド**: Python FastAPI (EC2 or ECS)
- **データベース**: Supabase PostgreSQL
- **定期更新**: AWS Lambda + EventBridge (4時間ごと)
- **スクレイピング**: Selenium + undetected-chromedriver

## 動作仕様

### 初回アクセス時
1. ユーザーがサイトにアクセス
2. データベースを確認
3. データがない場合は自動的にAmazonをスクレイピング
4. ChatGPTでトイレットペーパーの仕様を解析
5. データベースに保存して表示

### 定期更新（4時間ごと）
1. AWS Lambda が EventBridge により4時間ごとに起動
2. データベースの既存商品のASINリストを取得
3. 各商品の最新価格のみを取得
4. 価格と単価を再計算してデータベースを更新
5. 商品名、画像URL、ロール数、長さなどは変更しない

## 環境変数の設定

### 必要な環境変数
```bash
# OpenAI API (ChatGPT解析用)
OPENAI_API_KEY=sk-xxx

# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhxxx

# Amazon アフィリエイト (オプション)
NEXT_PUBLIC_AMAZON_PARTNER_TAG=your-tag-22
```

## デプロイ手順

### 1. Supabase セットアップ

1. Supabaseプロジェクトを作成
2. 以下のSQLでテーブルを作成：

```sql
CREATE TABLE toilet_paper_products (
    id SERIAL PRIMARY KEY,
    asin VARCHAR(20) UNIQUE NOT NULL,
    title TEXT NOT NULL,
    description TEXT,
    image_url TEXT,
    price INTEGER,
    price_regular INTEGER,
    on_sale BOOLEAN DEFAULT FALSE,
    review_avg NUMERIC(3,2),
    review_count INTEGER,
    roll_count INTEGER,
    length_m NUMERIC(10,2),
    total_length_m NUMERIC(10,2),
    price_per_roll NUMERIC(10,2),
    price_per_m NUMERIC(10,2),
    is_double BOOLEAN,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_toilet_paper_products_price_per_m ON toilet_paper_products(price_per_m);
CREATE INDEX idx_toilet_paper_products_updated_at ON toilet_paper_products(updated_at);
```

### 2. バックエンド (FastAPI) デプロイ

#### EC2での構築手順

1. EC2インスタンスを起動 (t3.medium以上推奨)
2. セキュリティグループで8000番ポートを開放
3. 以下のコマンドで環境構築：

```bash
# システムアップデート
sudo apt update && sudo apt upgrade -y

# Python 3.11インストール
sudo apt install python3.11 python3.11-venv python3-pip -y

# Chrome依存関係インストール
sudo apt install -y wget gnupg
wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
sudo apt update
sudo apt install -y google-chrome-stable

# プロジェクトをクローン
git clone https://github.com/your-repo/toilet-paper-price-compare.git
cd toilet-paper-price-compare/python-backend

# Python仮想環境作成
python3.11 -m venv venv
source venv/bin/activate

# 依存関係インストール
pip install -r requirements.txt

# 環境変数設定
cat > .env << EOF
OPENAI_API_KEY=sk-xxx
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhxxx
EOF

# systemdサービス作成
sudo cat > /etc/systemd/system/toilet-api.service << EOF
[Unit]
Description=Toilet Paper API
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/home/ubuntu/toilet-paper-price-compare/python-backend
Environment="PATH=/home/ubuntu/toilet-paper-price-compare/python-backend/venv/bin"
ExecStart=/home/ubuntu/toilet-paper-price-compare/python-backend/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# サービス起動
sudo systemctl daemon-reload
sudo systemctl enable toilet-api
sudo systemctl start toilet-api
```

### 3. Lambda 定期更新の設定

#### Lambda関数作成

1. AWS Lambdaで新しい関数を作成
   - ランタイム: Python 3.11
   - メモリ: 512MB
   - タイムアウト: 5分

2. Lambda Layerの作成（Chromeドライバー用）
```bash
# ローカルで作業
mkdir lambda-layer
cd lambda-layer
pip install -t python/ selenium undetected-chromedriver
zip -r chrome-layer.zip python/
# AWSコンソールからLayerとしてアップロード
```

3. Lambda関数のコードをアップロード
```bash
cd python-backend
zip -r lambda-deployment.zip lambda_function.py app/ -x "app/__pycache__/*"
# AWSコンソールからアップロード
```

4. 環境変数を設定
   - OPENAI_API_KEY
   - NEXT_PUBLIC_SUPABASE_URL
   - NEXT_PUBLIC_SUPABASE_ANON_KEY

#### EventBridge設定

1. EventBridge (CloudWatch Events) で新しいルールを作成
2. スケジュール式: `rate(4 hours)`
3. ターゲット: 作成したLambda関数

### 4. フロントエンド (Next.js) デプロイ

#### Vercelでのデプロイ

1. GitHubリポジトリをVercelに接続
2. 環境変数を設定：
   - `NEXT_PUBLIC_SUPABASE_URL`
   - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
   - `NEXT_PUBLIC_AMAZON_PARTNER_TAG`（オプション）

3. ビルド設定：
   - Framework Preset: Next.js
   - Build Command: `npm run build`
   - Output Directory: `.next`

4. APIエンドポイントを本番URLに変更：
   `app/toilet-paper/page.tsx` の38行目を修正：
   ```typescript
   // 開発環境
   const response = await fetch(`http://127.0.0.1:8000/api/search?${params}`);
   
   // 本番環境（EC2のパブリックIPまたはドメイン）
   const response = await fetch(`https://api.your-domain.com/api/search?${params}`);
   ```

### 5. 監視とログ

#### CloudWatch設定

1. Lambda関数のログは自動的にCloudWatchに記録される
2. EC2のAPIログ確認：
```bash
sudo journalctl -u toilet-api -f
```

#### エラー通知（オプション）

1. SNSトピックを作成
2. Lambda関数にエラー時のSNS通知を追加
3. メールで通知を受信

## トラブルシューティング

### よくある問題と対処法

1. **Lambda関数がタイムアウトする**
   - タイムアウトを10分に延長
   - メモリを1024MBに増やす

2. **Chromeドライバーエラー**
   - Lambda LayerにChrome binaryを含める
   - headless-chromiumを使用

3. **CORS エラー**
   - FastAPIのCORS設定で本番ドメインを追加
   ```python
   allow_origins=["https://your-frontend-domain.com"]
   ```

4. **データベース接続エラー**
   - Supabaseのダッシュボードで接続数を確認
   - 必要に応じてプランをアップグレード

## メンテナンス

### 定期メンテナンス項目

1. **月次**
   - CloudWatchログの確認と不要なログの削除
   - Lambda関数の実行回数とコストの確認
   - データベースサイズの確認

2. **週次**
   - エラーログの確認
   - スクレイピング成功率の確認

3. **必要に応じて**
   - ChatGPTプロンプトの調整（商品解析精度向上）
   - Amazonのサイト構造変更への対応

## コスト見積もり

### 推奨: サーバーレス構成（月額 約$5）

- **API Gateway + Lambda**: 
  - API呼び出し: 約$3.50
  - Lambda実行: 約$0.50
- **定期更新Lambda**: 約$1
- **CloudWatch Logs**: 約$0.50
- **合計**: 約$5/月

### 代替案1: EC2 Spot Instance（月額 約$10）

- **EC2 (t3.medium Spot)**: 約$8
- **Lambda定期更新**: 約$1
- **CloudWatch Logs**: 約$1
- **合計**: 約$10/月

### 代替案2: 無料ホスティングサービス

- **Render.com**: 無料プラン（512MB RAM、月750時間）
- **Railway.app**: 月$5クレジット付き無料プラン
- **Google Cloud Run**: 月200万リクエストまで無料
- **Lambda定期更新**: 約$1
- **合計**: 約$1/月

### 最小構成: EC2 t3.micro（月額 約$8）

- **EC2 (t3.micro)**: 約$7（無料枠終了後）
- **Lambda定期更新**: 約$1
- **合計**: 約$8/月

### その他のサービス

- **Supabase**: Free tier (500MB, 2GB転送量)
- **Vercel**: Free tier
- **OpenAI API**: 約$5/月（使用量による）

## セキュリティ注意事項

1. **環境変数の管理**
   - 本番環境では AWS Secrets Manager の使用を推奨
   - APIキーは定期的にローテーション

2. **アクセス制限**
   - API Gatewayでレート制限を設定
   - 必要に応じてIP制限

3. **データベース**
   - Supabaseの Row Level Security (RLS) を有効化
   - 読み取り専用のAPIキーを使用

## 連絡先

問題が発生した場合は以下に連絡：
- 技術サポート: [メールアドレス]
- 緊急時: [電話番号]

---

最終更新: 2025年8月15日